<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SketchInput</title>
    <link rel="stylesheet" href="<@css_path@>">
    <link href='<@font_css_path@>' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" href="about:blank">
  </head>
  <body>
    <div id="si-container">
      <div id="si-placeholder">
        Loading SketchInput...
      </div>
    </div>
    <script src="//cdn.ravenjs.com/1.1.19/native/raven.min.js"></script>
    <script>
      Raven.config('https://ba0147f0571642aea6c8228de3c3f1e1@app.getsentry.com/49449', {
        whitelistUrls: ['s3.amazonaws.com/1801-static-assets/si/']
      }).install();
    </script>
    <script src="<@vendor_bundle_path@>"></script>
    <script src="<@config_or_app_bundle_path@>"></script>
    <script>
      (function() {
        // Globals: config, si, setState, getState, getGrade, useBase64Encoding;
        var channel, __state, debugConfig, isLoaded;
        var DATA_URI_PREAMBLE = 'data:application/json;base64,';

        var loadTimer = window.setTimeout(function() {
          if (isLoaded) return;
          Raven.captureMessage('Did not load within 10 seconds', {tags: {shortname: 'loadTimeout'}});
        }, 10000);

        // Base64-encode the state to avoid multiple JSON escaping in edX
        window.useBase64Encoding = true;

        // A surrogate setState function that can be called before SketchInput has loaded
        window.setState = function setState(state) {
          if (state.indexOf(DATA_URI_PREAMBLE) === 0) {
            // This is a base64-encoded data URI; decode it
            state = atob(state.slice(DATA_URI_PREAMBLE.length));
          }

          if (isLoaded) si.setState(state);
          else __state = state;
        }

        if (window !== window.parent) {
          // We're inside a frame; initialize a new JSChannel
          channel = Channel.build({
            window: window.parent,
            origin: '*',
            scope: 'JSInput'
          });

          // Bind the channel setState immediately so we don't keep the host window waiting
          channel.bind('setState', function channelSetState(transaction, state) {
            return window.setState(state);
          });
        }

        debugConfig = {
          width: 750,
          height: 420,
          xrange: [-4.5, 4.5],
          yrange: [-2.5, 2.5],
          xscale: 'linear',
          yscale: 'linear',
          plugins: [
            {name: 'axes'},
            {name: 'freeform', id: 'f', label: 'Function f(x)', color: 'blue'},
            {name: 'freeform', id: 'g', label: 'Derivative g(x)', color: 'orange'},
            {name: 'vertical-line', id: 'va', label: 'Vertical asymptote', color: 'gray', dashStyle: 'dashdotted'},
            {name: 'horizontal-line', id: 'ha', label: 'Horizontal asymptote', color: 'gray', dashStyle: 'dashdotted'},
            {name: 'point', id: 'cp', label: 'Critical point', color: 'black', size: 15},
          ],
        };

        try {
          window.config = (window.location.hash === '#debug') ? debugConfig :
            JSON.parse(atob(
              window.location.hash
                .slice(1)
                .replace(/-/g, '+')
                .replace(/_/g, '/')
            ));
        }
        catch (error) {
          document.getElementById('si-placeholder').textContent =
            'Could not parse problem configuration data';
          Raven.captureException(error, {tags: {shortname: 'hashParseError'}});
          window.clearTimeout(loadTimer);
          return;  // Abort the loading process
        }

        System.import('lib/main').then(function(main) {
          window.si = new main.default(document.getElementById('si-container'), config);

          window.si.messageBus.on('ready', function() {
            isLoaded = true;
            if (__state) window.si.setState(__state);
          });

          window.si.messageBus.on('warnUser', function(type, error) {
            Raven.captureException(error, {tags: {shortname: type}});
          });

          window.getState = function() {
            return window.useBase64Encoding ? DATA_URI_PREAMBLE + btoa(si.getState()) : si.getState();
          };

          window.getGrade = si.getGradeable.bind(si);

          if (channel) {
            channel
              .bind('getState', window.getState)
              .bind('getGrade', window.getGrade);
          }
        }).catch(function(error) {
          Raven.captureException(error, {tags: {shortname: 'importPromiseError'}});
        });
      }());
    </script>
  </body>
</html>
